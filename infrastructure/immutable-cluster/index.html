<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Nico Braun - Immutable Cluster</title><link rel=icon href=/assets/favicon.ico><link rel=stylesheet href=/assets/base.css><link rel=stylesheet href=/assets/main.css><link rel=stylesheet href=/assets/chroma.css><body class=darker><nav id=nav></nav><section id=page class=post><aside id=menu><div class="tree-root tree-level-0"><section class=tree-level-1><h3>Linux</h3><ul><li class="tree-child tree-level-2"><a href=/linux/kvm-qemu-in-wsl2/>Kvm Qemu In Wsl2</a></ul><ul><li class="tree-child tree-level-2"><a href=/linux/effective-make/>Effective Make</a></ul></section><section class=tree-level-1><h3>Kubernetes</h3><ul><li class="tree-child tree-level-2"><a href=/kubernetes/kubernetes-dns/>Kubernetes Dns</a></ul></section><section class=tree-level-1><h3>Infrastructure</h3><ul><li class="tree-child tree-level-2"><a href=/infrastructure/immutable-cluster/>Immutable Cluster</a></ul></section><section class=tree-level-1><h3>Container</h3><ul><li class="tree-child tree-level-2"><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/docker-sd-and-lb/>Docker Sd And Lb</a></ul></section><section class=tree-level-1><h3>Programming</h3><ul><li class="tree-child tree-level-2"><a href=/programming/bit-flags-in-go/>Bit Flags In Go</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/opengl-windows-vscode/>Opengl Windows Vscode</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/python-cheat-sheet/>Python Cheat Sheet</a></ul></section></div></aside><main id=content><nav><ul class=bread-crumbs><li><a href=/>Home</a><li role=separator class=vr>/<li><a href=/infrastructure/>Infrastructure</a><li role=separator class=vr>/<li><a href=/infrastructure/immutable-cluster/>Immutable Cluster</a></ul></nav><article class=post><section class=post-content><h1 id=immutable-infrastructure-in-aws-with-packer-ansible-and-terraform>Immutable Infrastructure in AWS with Packer, Ansible and Terraform</h1><blockquote><p>Immutable infrastructure is an approach to managing services and software deployments on IT resources wherein components are replaced rather than changed. An application or services is effectively redeployed each time any change occurs.</blockquote><p>In this post I am going to show how one can create a workflow based in the idea of immutable infrastructure. You can find the full working code in github <a href=https://github.com/bluebrown/immutable-cluster>https://github.com/bluebrown/immutable-cluster</a>.<h2 id=the-recipe>The Recipe</h2><p>Since the goal is to simply replace the instance on each application release, we want to create a machine image containing the application. This way we can swap out the whole instance quickly without further installation steps after provisioning. This is sometimes called a <a href=https://opensource.com/article/19/7/what-golden-image>golden image</a>. We are going to use <a href=https://www.packer.io/>Packer</a> & <a href=https://www.ansible.com/>Ansible</a> for this.<p>Further, we want to manage our infrastructure as code. <a href=https://www.terraform.io/>Terraform</a> is a good choice for this. It can create, change and destroy infrastructure remotely and keeps track of the current state of our system.<p>With a golden image and infrastructure as code, we can throw away the complete environment, in this case the vpc with instances, and create a new one within minutes if we wish. Usually we only want to swap the instances though.<h2 id=prerequisites>Prerequisites</h2><p>To follow along you need:<ul><li>an <a href=https://aws.amazon.com/>AWS</a> account & access tokens<li>have <a href=https://www.ansible.com/>Ansible</a> installed<li>have <a href=https://www.packer.io/>Packer</a> installed<li>have <a href=https://www.terraform.io/>Terraform</a> installed<li>have the <a href=https://aws.amazon.com/cli/>AWS CLI</a> version 2 installed</ul><h2 id=creating-a-custom-image-with-packer>Creating a Custom Image with Packer</h2><p><strong>If you are using a custom vpc, make sure to configure <a href=https://www.packer.io/>Packer</a> to use a subnet with automatic public ip assignment and a route to the internet gateway.</strong><h3 id=packer-file>Packer File</h3><p>First we create a <a href=https://www.packer.io/>Packer</a> file with some information about the image we want to create.<p>Most importantly We specify the <code>region</code>. By default our <code>AMI</code> will only be available in this <code>region</code>.<p>We specify <a href=https://www.ansible.com/>Ansible</a> as provisioner. It will execute the <code>playbook</code> on the temporary instance to apply additional configuration.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;aws_access_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sensitive</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;aws_secret_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sensitive</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>source</span> <span class=s>&#34;amazon-ebs&#34;</span> <span class=s>&#34;example&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>access_key</span>      <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>aws_access_key</span>
</span></span><span class=line><span class=cl>  <span class=nx>secret_key</span>      <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>aws_secret_key</span>
</span></span><span class=line><span class=cl>  <span class=nx>ssh_timeout</span>     <span class=p>=</span> <span class=s>&#34;30s&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>region</span>          <span class=p>=</span> <span class=s>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=c1>// amazon linux 2
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>source_ami</span>      <span class=p>=</span> <span class=s>&#34;ami-0db9040eb3ab74509&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ssh_username</span>    <span class=p>=</span> <span class=s>&#34;ec2-user&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ami_name</span>        <span class=p>=</span> <span class=s>&#34;packer nginx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance_type</span>   <span class=p>=</span> <span class=s>&#34;t2.micro&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>skip_create_ami</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>build</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sources</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;source.amazon-ebs.example&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>provisioner</span> <span class=s>&#34;ansible&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>playbook_file</span> <span class=p>=</span> <span class=s>&#34;playbook.yml&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span></code></pre><h3 id=ansible-playbook>Ansible Playbook</h3><p>Once <a href=https://www.packer.io/>Packer</a> has created the temporary instance, we use <a href=https://www.ansible.com/>Ansible</a> to apply additional configuration.<p>The playbook tells ansible to install and enable the nginx service. The result will be <code>nginx</code> serving the default page on port 80 when the <code>instance</code> is booted.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>set up nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hosts</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>become</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tasks</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ensure extra repo is available</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>amazon-linux-extras]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>present</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>enable nginx repo</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>shell</span><span class=p>:</span><span class=w> </span><span class=l>amazon-linux-extras enable nginx1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>yum-clean-metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=l>yum clean metadata</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>warn</span><span class=p>:</span><span class=w> </span><span class=kc>no</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>install nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>yum</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=l>nginx]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>state</span><span class=p>:</span><span class=w> </span><span class=l>latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>enable nginx service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>enabled</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span></code></pre><h3 id=build>Build</h3><p>With the 2 configuration files we can validate the input and build our custom <code>AMI</code> in <a href=https://aws.amazon.com/>AWS</a>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>packer validate .
</span></span><span class=line><span class=cl>packer build .
</span></span></code></pre><h3 id=the-ami>The AMI</h3><p>Once the process is completed, we can use the <a href=https://aws.amazon.com/cli/>AWS CLI</a> to inspect the created <code>AMI</code> and find the <code>ImageId</code>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=err>$</span> <span class=err>aws</span> <span class=err>ec</span><span class=mi>2</span> <span class=err>describe-images</span> <span class=err>--owner</span> <span class=err>self</span> <span class=err>--region</span> <span class=err>eu-central</span><span class=mi>-1</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;Images&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Architecture&#34;</span><span class=p>:</span> <span class=s2>&#34;x86_64&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;CreationDate&#34;</span><span class=p>:</span> <span class=s2>&#34;2021-04-18T00:00:05.000Z&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ImageId&#34;</span><span class=p>:</span> <span class=s2>&#34;ami-01cce7ac6df33f08e&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ImageLocation&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;your_account_id&gt;/packer nginx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;ImageType&#34;</span><span class=p>:</span> <span class=s2>&#34;machine&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Public&#34;</span><span class=p>:</span> <span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;OwnerId&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;your_account_id&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;PlatformDetails&#34;</span><span class=p>:</span> <span class=s2>&#34;Linux/UNIX&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;UsageOperation&#34;</span><span class=p>:</span> <span class=s2>&#34;RunInstances&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;State&#34;</span><span class=p>:</span> <span class=s2>&#34;available&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;BlockDeviceMappings&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>                <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;DeviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;/dev/xvda&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&#34;Ebs&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;DeleteOnTermination&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;SnapshotId&#34;</span><span class=p>:</span> <span class=s2>&#34;snap-0692717e44e63cbd1&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;VolumeSize&#34;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;VolumeType&#34;</span><span class=p>:</span> <span class=s2>&#34;gp2&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&#34;Encrypted&#34;</span><span class=p>:</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>],</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;EnaSupport&#34;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Hypervisor&#34;</span><span class=p>:</span> <span class=s2>&#34;xen&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;Name&#34;</span><span class=p>:</span> <span class=s2>&#34;packer nginx&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;RootDeviceName&#34;</span><span class=p>:</span> <span class=s2>&#34;/dev/xvda&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;RootDeviceType&#34;</span><span class=p>:</span> <span class=s2>&#34;ebs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;SriovNetSupport&#34;</span><span class=p>:</span> <span class=s2>&#34;simple&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=nt>&#34;VirtualizationType&#34;</span><span class=p>:</span> <span class=s2>&#34;hvm&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h2 id=deploying-the-infrastructure-with-terraform>Deploying the Infrastructure with Terraform</h2><p>Now we have our custom <code>AMI</code> in the <code>eu-central-1</code> region. Next we will use <a href=https://www.terraform.io/>Terraform</a> to deploy this image together with the required infrastructure.<p><img src=https://user-images.githubusercontent.com/39703898/115515253-dc43b000-a27c-11eb-8c96-b7fd705b7a9f.png alt="image of infrastructure with elb"><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;aws_access_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sensitive</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;aws_secret_key&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>sensitive</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;ami_id&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>default</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>variable</span> <span class=s>&#34;domain&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>default</span> <span class=p>=</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>source</span>  <span class=p>=</span> <span class=s>&#34;hashicorp/aws&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>version</span> <span class=p>=</span> <span class=s>&#34;~&gt; 3.0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>provider</span> <span class=s>&#34;aws&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>region</span>     <span class=p>=</span> <span class=s>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>access_key</span> <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>aws_access_key</span>
</span></span><span class=line><span class=cl>  <span class=nx>secret_key</span> <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>aws_secret_key</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h3 id=vpc>VPC</h3><p>First we create a simple <code>VPC</code> with 2 <code>subnets</code> in different <code>availability zones</code>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_vpc&#34;</span> <span class=s>&#34;packer&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>cidr_block</span> <span class=p>=</span> <span class=s>&#34;10.0.0.0/16&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>        <span class=p>=</span> <span class=s>&#34;packer&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Description</span> <span class=p>=</span> <span class=s>&#34;sample vpc with 2 public subnets in 2 availability zones and a network load balancer for high availability&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_internet_gateway&#34;</span> <span class=s>&#34;inet&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span> <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;packer internet gateway&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_default_route_table&#34;</span> <span class=s>&#34;public&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>default_route_table_id</span> <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>default_route_table_id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>route</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>cidr_block</span> <span class=p>=</span> <span class=s>&#34;0.0.0.0/0&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>gateway_id</span> <span class=p>=</span> <span class=nx>aws_internet_gateway</span><span class=p>.</span><span class=nx>inet</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;public route table&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_subnet&#34;</span> <span class=s>&#34;a&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span>            <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>cidr_block</span>        <span class=p>=</span> <span class=s>&#34;10.0.0.0/24&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>availability_zone</span> <span class=p>=</span> <span class=s>&#34;eu-central-1a&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;public subnet a&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>map_public_ip_on_launch</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_subnet&#34;</span> <span class=s>&#34;b&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span>            <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>cidr_block</span>        <span class=p>=</span> <span class=s>&#34;10.0.1.0/24&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>availability_zone</span> <span class=p>=</span> <span class=s>&#34;eu-central-1b&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;public subnet b&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>map_public_ip_on_launch</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h3 id=security-groups>Security Groups</h3><p>Next, we create the <code>security groups</code>.<p>The default security group has only a reference to itself. It is used to allow traffic to flow between the <code>ALB</code> and its <code>targets</code>.<p>The second <code>security group</code> is to allow tcp traffic from the public web to the <code>ALB</code> on port 80(HTTP) and 443 (HTTPS).<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_default_security_group&#34;</span> <span class=s>&#34;internal&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span> <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;default internal sg&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>    <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span>        <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>from_port</span>   <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>to_port</span>     <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span> <span class=p>=</span> <span class=s>&#34;self ref&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>egress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>    <span class=p>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>    <span class=nx>self</span>        <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>    <span class=nx>from_port</span>   <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>to_port</span>     <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span> <span class=p>=</span> <span class=s>&#34;self ref&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_security_group&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span> <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span> <span class=p>=</span> <span class=s>&#34;web sg for nginx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span>      <span class=p>=</span> <span class=s>&#34;http traffic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>from_port</span>        <span class=p>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>    <span class=nx>to_port</span>          <span class=p>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>         <span class=p>=</span> <span class=s>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>cidr_blocks</span>      <span class=p>=</span> <span class=p>[</span><span class=s>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>ipv6_cidr_blocks</span> <span class=p>=</span> <span class=p>[</span><span class=s>&#34;::/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>ingress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>description</span>      <span class=p>=</span> <span class=s>&#34;http traffic&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>from_port</span>        <span class=p>=</span> <span class=mi>443</span>
</span></span><span class=line><span class=cl>    <span class=nx>to_port</span>          <span class=p>=</span> <span class=mi>443</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>         <span class=p>=</span> <span class=s>&#34;tcp&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>cidr_blocks</span>      <span class=p>=</span> <span class=p>[</span><span class=s>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>ipv6_cidr_blocks</span> <span class=p>=</span> <span class=p>[</span><span class=s>&#34;::/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>egress</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>from_port</span>        <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>to_port</span>          <span class=p>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=nx>protocol</span>         <span class=p>=</span> <span class=s>&#34;-1&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>cidr_blocks</span>      <span class=p>=</span> <span class=p>[</span><span class=s>&#34;0.0.0.0/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=nx>ipv6_cidr_blocks</span> <span class=p>=</span> <span class=p>[</span><span class=s>&#34;::/0&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h3 id=logging>Logging</h3><p>We are going to create an <code>S3 bucket</code> with the required access <code>policy</code> to use it as log destination for the <code>ALB</code> in the next section.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_s3_bucket&#34;</span> <span class=s>&#34;logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>bucket</span> <span class=p>=</span> <span class=s>&#34;com.myorg.logs&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>acl</span>    <span class=p>=</span> <span class=s>&#34;private&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>force_destroy</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=nx>tags</span> <span class=p>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>Name</span>        <span class=p>=</span> <span class=s>&#34;nginx cluster access logs&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>Environment</span> <span class=p>=</span> <span class=s>&#34;Dev&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>data</span> <span class=s>&#34;aws_elb_service_account&#34;</span> <span class=s>&#34;main&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>region</span> <span class=p>=</span> <span class=s>&#34;eu-central-1&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_s3_bucket_policy&#34;</span> <span class=s>&#34;logs&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>bucket</span> <span class=p>=</span> <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>logs</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>policy</span> <span class=p>=</span> <span class=o>&lt;&lt;</span><span class=nx>POLICY</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Version&#34;</span><span class=p>:</span> <span class=s>&#34;2012-10-17&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Id&#34;</span><span class=p>:</span> <span class=s>&#34;allow-elb-logs&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Statement&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Sid&#34;</span><span class=p>:</span> <span class=s>&#34;RegionRootArn&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Effect&#34;</span><span class=p>:</span> <span class=s>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;AWS&#34;</span><span class=p>:</span> <span class=s>&#34;${data.aws_elb_service_account.main.arn}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Action&#34;</span><span class=p>:</span> <span class=s>&#34;s3:PutObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Resource&#34;</span><span class=p>:</span> <span class=s>&#34;${aws_s3_bucket.logs.arn}/*&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Sid&#34;</span><span class=p>:</span> <span class=s>&#34;AWSLogDeliveryWrite&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Effect&#34;</span><span class=p>:</span> <span class=s>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Service&#34;</span><span class=p>:</span> <span class=s>&#34;delivery.logs.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Action&#34;</span><span class=p>:</span> <span class=s>&#34;s3:PutObject&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Resource&#34;</span><span class=p>:</span> <span class=s>&#34;${aws_s3_bucket.logs.arn}/*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Condition&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;StringEquals&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#34;s3:x-amz-acl&#34;</span><span class=p>:</span> <span class=s>&#34;bucket-owner-full-control&#34;</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Sid&#34;</span><span class=p>:</span> <span class=s>&#34;AWSLogDeliveryAclCheck&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Effect&#34;</span><span class=p>:</span> <span class=s>&#34;Allow&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Principal&#34;</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=s>&#34;Service&#34;</span><span class=p>:</span> <span class=s>&#34;delivery.logs.amazonaws.com&#34;</span>
</span></span><span class=line><span class=cl>            <span class=p>},</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Action&#34;</span><span class=p>:</span> <span class=s>&#34;s3:GetBucketAcl&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;Resource&#34;</span><span class=p>:</span> <span class=s>&#34;${aws_s3_bucket.logs.arn}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>POLICY</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h3 id=load-balancing>Load balancing</h3><p>Next, an application load balancer (ALB) is created with a 2 <code>listeners</code>.<p>The first <code>listener</code> will listen on port 80 and redirect the traffic to port 443.<p>The second <code>listener</code> will serve a tls certificate, that is imported from <code>ACM</code>, on port 443. After the <code>TLS handshake</code> it will forward the traffic over http on port 80 to the target group, also known asl <code>TLS Termination</code>.<p>I am assuming that you have already uploaded your own cert or that you have issued one with ACM. There <a href=https://github.com/bluebrown/immutable-cluster/tree/no-tls>a branch without tls</a> in this repo.<p>The <code>target group</code> will be populated by the <code>auto scaling group</code> in the next section.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_lb&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>               <span class=p>=</span> <span class=s>&#34;packer-nginx&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>internal</span>           <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>  <span class=nx>load_balancer_type</span> <span class=p>=</span> <span class=s>&#34;application&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>security_groups</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws_default_security_group</span><span class=p>.</span><span class=nx>internal</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws_security_group</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>subnets</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws_subnet</span><span class=p>.</span><span class=nx>a</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws_subnet</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>access_logs</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>bucket</span>  <span class=p>=</span> <span class=nx>aws_s3_bucket</span><span class=p>.</span><span class=nx>logs</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>enabled</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_lb_target_group&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>     <span class=p>=</span> <span class=s>&#34;web-tg&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span>     <span class=p>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>  <span class=nx>protocol</span> <span class=p>=</span> <span class=s>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_id</span>   <span class=p>=</span> <span class=nx>aws_vpc</span><span class=p>.</span><span class=nx>packer</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_lb_listener&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>load_balancer_arn</span> <span class=p>=</span> <span class=nx>aws_lb</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span>              <span class=p>=</span> <span class=s>&#34;80&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>protocol</span>          <span class=p>=</span> <span class=s>&#34;HTTP&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>default_action</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>type</span> <span class=p>=</span> <span class=s>&#34;redirect&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>redirect</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>port</span>        <span class=p>=</span> <span class=s>&#34;443&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>protocol</span>    <span class=p>=</span> <span class=s>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl>      <span class=nx>status_code</span> <span class=p>=</span> <span class=s>&#34;HTTP_301&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>data</span> <span class=s>&#34;aws_acm_certificate&#34;</span> <span class=s>&#34;mycert&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>domain</span>   <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>domain</span>
</span></span><span class=line><span class=cl>  <span class=nx>statuses</span> <span class=p>=</span> <span class=p>[</span><span class=s>&#34;ISSUED&#34;</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>most_recent</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_lb_listener&#34;</span> <span class=s>&#34;websecure&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>load_balancer_arn</span> <span class=p>=</span> <span class=nx>aws_lb</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span>              <span class=p>=</span> <span class=s>&#34;443&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>protocol</span>          <span class=p>=</span> <span class=s>&#34;HTTPS&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ssl_policy</span>        <span class=p>=</span> <span class=s>&#34;ELBSecurityPolicy-2016-08&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>certificate_arn</span>   <span class=p>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>aws_acm_certificate</span><span class=p>.</span><span class=nx>mycert</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=nx>default_action</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>type</span>             <span class=p>=</span> <span class=s>&#34;forward&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>target_group_arn</span> <span class=p>=</span> <span class=nx>aws_lb_target_group</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h3 id=autoscaling>Autoscaling</h3><p>Lastly, we create a launch template and auto scaling group to launch new instances of the custom <code>AMI</code>.<p>We will require a minimum of 2 instances with a desired count of 2 instances. Optionally we allow to scale up to 4 instances if instances reach their resource limit.<p>The <code>strategy</code> of the <code>placement group</code> is set to <code>partition</code> which means that the instances should get spread across the racks in the physical data centers.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_placement_group&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>     <span class=p>=</span> <span class=s>&#34;web-pl&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>strategy</span> <span class=p>=</span> <span class=s>&#34;partition&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_launch_template&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name_prefix</span>   <span class=p>=</span> <span class=s>&#34;web-lt-&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>image_id</span>      <span class=p>=</span> <span class=kd>var</span><span class=p>.</span><span class=nx>ami_id</span>
</span></span><span class=line><span class=cl>  <span class=nx>instance_type</span> <span class=p>=</span> <span class=s>&#34;t2.micro&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_security_group_ids</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=nx>aws_default_security_group</span><span class=p>.</span><span class=nx>internal</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_autoscaling_group&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>name</span>                <span class=p>=</span> <span class=s>&#34;webscale&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>vpc_zone_identifier</span> <span class=p>=</span> <span class=p>[</span><span class=nx>aws_subnet</span><span class=p>.</span><span class=nx>a</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span> <span class=nx>aws_subnet</span><span class=p>.</span><span class=nx>b</span><span class=p>.</span><span class=nx>id</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=nx>desired_capacity</span>    <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=nx>max_size</span>            <span class=p>=</span> <span class=mi>4</span>
</span></span><span class=line><span class=cl>  <span class=nx>min_size</span>            <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>  <span class=nx>placement_group</span>     <span class=p>=</span> <span class=nx>aws_placement_group</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>launch_template</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>id</span>      <span class=p>=</span> <span class=nx>aws_launch_template</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>    <span class=nx>version</span> <span class=p>=</span> <span class=s>&#34;$Latest&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>lifecycle</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>ignore_changes</span> <span class=p>=</span> <span class=p>[</span><span class=nx>load_balancers</span><span class=p>,</span> <span class=nx>target_group_arns</span><span class=p>]</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>resource</span> <span class=s>&#34;aws_autoscaling_attachment&#34;</span> <span class=s>&#34;web&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>autoscaling_group_name</span> <span class=p>=</span> <span class=nx>aws_autoscaling_group</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>id</span>
</span></span><span class=line><span class=cl>  <span class=nx>alb_target_group_arn</span>   <span class=p>=</span> <span class=nx>aws_lb_target_group</span><span class=p>.</span><span class=nx>web</span><span class=p>.</span><span class=nx>arn</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre><h2 id=deploy>Deploy</h2><p>Now we can deploy the infrastructure. Run <code>terraform apply</code> and confirm the prompt. The process will take a couple minutes until all the resources are created and ready.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>terraform apply
</span></span></code></pre><p>You can use <a href=https://aws.amazon.com/cli/>AWS CLI</a> to see if the targets of the load balancer are <em>healthy</em>.<p>They may not be ready yet. If that is the case, just wait a couple minutes and check again.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ <span class=nv>arn</span><span class=o>=</span><span class=k>$(</span>aws elbv2 describe-target-groups --name web-tg --query <span class=s2>&#34;TargetGroups[0].TargetGroupArn&#34;</span> --output text<span class=k>)</span>
</span></span><span class=line><span class=cl>$ aws elbv2 describe-target-health --target-group-arn <span class=s2>&#34;</span><span class=nv>$arn</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;TargetHealthDescriptions&#34;</span>: <span class=o>[</span>
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Target&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Id&#34;</span>: <span class=s2>&#34;i-0b8137e9710a695a3&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Port&#34;</span>: <span class=m>80</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;HealthCheckPort&#34;</span>: <span class=s2>&#34;80&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;TargetHealth&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>,
</span></span><span class=line><span class=cl>        <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;Target&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Id&#34;</span>: <span class=s2>&#34;i-08db17910a66c9372&#34;</span>,
</span></span><span class=line><span class=cl>                <span class=s2>&#34;Port&#34;</span>: <span class=m>80</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;HealthCheckPort&#34;</span>: <span class=s2>&#34;80&#34;</span>,
</span></span><span class=line><span class=cl>            <span class=s2>&#34;TargetHealth&#34;</span>: <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=s2>&#34;State&#34;</span>: <span class=s2>&#34;healthy&#34;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre><p>Once the targets are marked as healthy, we need to point a <code>CNAME record</code> from our domain to the <code>ELB DNS</code>. I am managing my certificate with <code>Linode</code>, so I will give an example of how to do it via <a href=https://www.linode.com/docs/guides/linode-cli/>linode-cli</a>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nv>dns</span><span class=o>=</span><span class=k>$(</span>aws elbv2 describe-load-balancers --name <span class=s2>&#34;packer-nginx&#34;</span> --query <span class=s2>&#34;LoadBalancers[0].DNSName&#34;</span> --output text<span class=k>)</span>
</span></span><span class=line><span class=cl>linode-cli domains records-create --type CNAME --name elb --target <span class=nv>$dns</span> --ttl_sec <span class=m>300</span>  &lt;my-domain-id&gt;
</span></span></code></pre><p>You can now visit the url in your browse under the configured subdomain.<p><img src=https://user-images.githubusercontent.com/39703898/115831360-64ef5700-a409-11eb-9c8f-5c44fb06be11.png alt="nginx default web page"><p>Thats it!<p>The application is deployed from a custom <code>AMI</code> across 2 <code>availability zones</code> and utilizing <code>autoscaling</code>. The traffic is routed via <code>ELB</code> which also performs <code>TLS Termination</code>.<p>Additionally, e have our whole infrastructure as code which we can source control.<h2 id=cleaning-up>Cleaning Up</h2><p>In order to avoid cost, lets remove all created resources.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>terraform destroy
</span></span></code></pre><p>Since the AMI and snapshot was not created with <a href=https://www.terraform.io/>Terraform</a>, it wont be destroyed by the former command. We are going to remove them via CLI.<h3 id=deregister-image>Deregister Image</h3><pre tabindex=0 class=chroma><code><span class=line><span class=cl>aws ec2 deregister-image --image-id &lt;your-ami-id&gt;
</span></span></code></pre><h3 id=find-the-snapshot-id>Find the snapshot Id</h3><pre tabindex=0 class=chroma><code><span class=line><span class=cl>aws ec2 describe-snapshots --owner self
</span></span></code></pre><h3 id=delete-snapshot>Delete snapshot</h3><pre tabindex=0 class=chroma><code><span class=line><span class=cl>aws ec2 delete-snapshot --snapshot-id &lt;your-snap-id&gt;
</span></span></code></pre><h3 id=remove-cname-record>Remove cname record</h3><pre tabindex=0 class=chroma><code><span class=line><span class=cl>linode-cli domains records-delete &lt;main-id&gt; &lt;record-id&gt;
</span></span></code></pre></section><footer class=post-footer><p><span>Nico Braun</span>&nbsp;-&nbsp;<time>April 23, 2021</time><p><a href=#nav class=no-pop>Back to Top</a></footer></article></main><aside id=context><section class=toc><h3>What is on this page?</h3><ul><li><a href=#the-recipe>The Recipe</a><li><a href=#prerequisites>Prerequisites</a><li><a href=#creating-a-custom-image-with-packer>Creating a Custom Image with Packer</a><ul><li><a href=#packer-file>Packer File</a><li><a href=#ansible-playbook>Ansible Playbook</a><li><a href=#build>Build</a><li><a href=#the-ami>The AMI</a></ul><li><a href=#deploying-the-infrastructure-with-terraform>Deploying the Infrastructure with Terraform</a><ul><li><a href=#vpc>VPC</a><li><a href=#security-groups>Security Groups</a><li><a href=#logging>Logging</a><li><a href=#load-balancing>Load balancing</a><li><a href=#autoscaling>Autoscaling</a></ul><li><a href=#deploy>Deploy</a><li><a href=#cleaning-up>Cleaning Up</a><ul><li><a href=#deregister-image>Deregister Image</a><li><a href=#find-the-snapshot-id>Find the snapshot Id</a><li><a href=#delete-snapshot>Delete snapshot</a><li><a href=#remove-cname-record>Remove cname record</a></ul></ul></section></aside></section><footer id=footer><section id=socials><a href=https://github.com/bluebrown class="social-link no-pop"><svg class="social-icon">
<path
  d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8" /></svg><span>bluebrown</span></a>
<a href=https://www.twitter.com/codingsafari class="social-link no-pop"><svg class="social-icon">
<path
  d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" /></svg><span>codingsafari</span></a>
<a href=https://www.linkedin.com/in/nico-braun class="social-link no-pop"><svg class="social-icon">
<path
  d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" /></svg><span>nico-braun</span></a>
<a href=https://stackoverflow.com/users/9208887/the-fool class="social-link no-pop"><svg class="social-icon">
<path
  d="M12.566,14.12v-4.08h1.359v5.44H1.686v-5.44h1.36v4.08H12.566z M10.336,0.52L9.269,1.315l3.978,5.358l1.068-0.803 L10.336,0.52z M4.406,12.76h6.8V11.4h-6.8V12.76z M12.158,7.945L7.03,3.675l0.851-1.02l5.128,4.271L12.158,7.945z M5.357,6.646 l6.053,2.815l0.558-1.21L5.916,5.437L5.357,6.64V6.646z M11.227,10.91L4.494,9.774l0.272-1.306l6.549,1.306L11.227,10.91z" /></svg><span>the-fool</span></a></section></footer>