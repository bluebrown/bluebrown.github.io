<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Nico Braun - Effective Make</title><link rel=icon href=/assets/favicon.ico><link rel=stylesheet href=/assets/base.css><link rel=stylesheet href=/assets/main.css><link rel=stylesheet href=/assets/chroma.css><body class=darker><nav id=nav></nav><section id=page class=post><aside id=menu><div class="tree-root tree-level-0"><section class=tree-level-1><h3>Linux</h3><ul><li class="tree-child tree-level-2"><a href=/linux/kvm-qemu-in-wsl2/>Kvm Qemu In Wsl2</a></ul><ul><li class="tree-child tree-level-2"><a href=/linux/effective-make/>Effective Make</a></ul></section><section class=tree-level-1><h3>Kubernetes</h3><ul><li class="tree-child tree-level-2"><a href=/kubernetes/kubernetes-dns/>Kubernetes Dns</a></ul></section><section class=tree-level-1><h3>Infrastructure</h3><ul><li class="tree-child tree-level-2"><a href=/infrastructure/immutable-cluster/>Immutable Cluster</a></ul></section><section class=tree-level-1><h3>Container</h3><ul><li class="tree-child tree-level-2"><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/docker-sd-and-lb/>Docker Sd And Lb</a></ul></section><section class=tree-level-1><h3>Programming</h3><ul><li class="tree-child tree-level-2"><a href=/programming/bit-flags-in-go/>Bit Flags In Go</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/opengl-windows-vscode/>Opengl Windows Vscode</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/python-cheat-sheet/>Python Cheat Sheet</a></ul></section></div></aside><main id=content><nav><ul class=bread-crumbs><li><a href=/>Home</a><li role=separator class=vr>/<li><a href=/linux/>Linux</a><li role=separator class=vr>/<li><a href=/linux/effective-make/>Effective Make</a></ul></nav><article class=post><section class=post-content><h1 id=effective-make>Effective Make</h1><h2 id=concurrent-jobs>Concurrent Jobs</h2><p>If you want to speed up your builds through concurrency, you need to ensure the
goals and prerequisites are structured such that running the goals in concurrency
does not cause trouble.<p>Below is an example. prerequisites, added to the goal's prerequisite list (<code>goal: prereqs...</code>), should be able to run concurrently. If there are prerequisites that
need to run in sequence, they should be moved to the goals body. Inside the body
one can still run some prerequisites concurrently, by invoking make with multiple
goals.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nf>all</span><span class=o>:</span> <span class=n>a</span> <span class=n>b</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>  <span class=k>$(</span>MAKE<span class=k>)</span> d
</span></span><span class=line><span class=cl>  <span class=k>$(</span>MAKE<span class=k>)</span> e
</span></span><span class=line><span class=cl>  <span class=k>$(</span>MAKE<span class=k>)</span> f g
</span></span></code></pre><p>The order of execution, when concurrency is enabled, will be:<ol><li>a, b and c<li>d<li>e<li>f and g</ol><p>To enable concurrency, use the <code>-j</code> flag:<blockquote><pre tabindex=0 class=chroma><code><span class=line><span class=cl>make -j all
</span></span><span class=line><span class=cl><span class=c1># -j [N], --jobs[=N]  Allow N jobs at once; infinite jobs with no arg.</span>
</span></span></code></pre></blockquote><p>This also means, that some script snippets, should be moved to its own goal, so
that it can be controlled with the concurrency primitives.<p>instead of:<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nf>work</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  cp a b
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> c &gt; d
</span></span><span class=line><span class=cl>  cat b c &gt; e
</span></span></code></pre><p>do something like:<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nf>work</span><span class=o>:</span> <span class=n>copy</span> <span class=n>write</span>
</span></span><span class=line><span class=cl>  cat b c &gt; e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>copy</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  cp a b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>write</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> c &gt; d
</span></span></code></pre><p>That will allow to run both, <code>cp</code> and <code>echo</code>, concurrently. Note how the <code>cat</code>
command, which depends on both tasks, is still in the goals body, leading to it
being executed after copy and write have been, potentially concurrently,
executed.<h2 id=lazy-execution>Lazy Execution</h2><p>Make was originally designed as a build system for C projects. Therefore, a lot
of its functionality revolves around files (and other resources) the recipes
produce. Make can determine if a goal is up to date or needs to be rerun, based
on change timestamps of the prerequisites.<p>For example, if we change the above script to have the goals match the file
names the recipes produce, we can help make to know when a recipe should be
rerun.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nf>e</span><span class=o>:</span> <span class=n>b</span> <span class=n>c</span>
</span></span><span class=line><span class=cl>  cat b c &gt; e
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>b</span><span class=o>:</span> <span class=n>a</span>
</span></span><span class=line><span class=cl>  cp a b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>d</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> c &gt; d
</span></span></code></pre><p>Note, how the <code>b</code> goal has a prerequisite to <code>a</code>, even though a is not a goal. So
prerequisites can also be local files.<h3 id=order-only-prerequisites>Order Only Prerequisites</h3><p>If you want to depend on a local folder, that will not work. As soon as you
create a file in the directory, the directory counts as updated, so make will
always re-run the recipe.<p>So if you have the below Makefile, you may be surprised to see that the tools is
downloaded again, every time the results.txt is produced.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>results.txt: bin/tool
</span></span><span class=line><span class=cl>  bin/tool &gt; results.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bin/tool: bin
</span></span><span class=line><span class=cl> curl <span class=s2>&#34;https://my.org/tool&#34;</span> -o bin/tool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bin:
</span></span><span class=line><span class=cl> mkdir -p bin
</span></span></code></pre><p>The solution to that is an <a href=https://www.gnu.org/software/make/manual/make.html#Prerequisite-Types>order-only
prerequisite</a>.
Note the <code>|</code> before listing <code>bin</code> as prerequisite.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>bin/tool: <span class=p>|</span> bin
</span></span><span class=line><span class=cl> curl <span class=s2>&#34;https://my.org/tool&#34;</span> -o bin/tool
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bin:
</span></span><span class=line><span class=cl> mkdir -p bin
</span></span></code></pre><p>This will ensure bin is created before bin/tool but without forcing the target
to bin/tool to be updated if bin changes.</section><footer class=post-footer><p><span>Nico Braun</span>&nbsp;-&nbsp;<time>September 03, 2023</time><p><a href=#nav class=no-pop>Back to Top</a></footer></article></main><aside id=context><section class=toc><h3>What is on this page?</h3><ul><li><a href=#concurrent-jobs>Concurrent Jobs</a><li><a href=#lazy-execution>Lazy Execution</a><ul><li><a href=#order-only-prerequisites>Order Only Prerequisites</a></ul></ul></section><section class=releated><h3>Related</h3><ul><li><a href=/linux/kvm-qemu-in-wsl2/>Kvm Qemu In Wsl2
<small>- Nico Braun</small>
<small>- May 03, 2024</small></a></ul></section></aside></section><footer id=footer><section id=socials><a href=https://github.com/bluebrown class="social-link no-pop"><svg class="social-icon">
<path
  d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8" /></svg><span>bluebrown</span></a>
<a href=https://www.twitter.com/codingsafari class="social-link no-pop"><svg class="social-icon">
<path
  d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" /></svg><span>codingsafari</span></a>
<a href=https://www.linkedin.com/in/nico-braun class="social-link no-pop"><svg class="social-icon">
<path
  d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" /></svg><span>nico-braun</span></a>
<a href=https://stackoverflow.com/users/9208887/the-fool class="social-link no-pop"><svg class="social-icon">
<path
  d="M12.566,14.12v-4.08h1.359v5.44H1.686v-5.44h1.36v4.08H12.566z M10.336,0.52L9.269,1.315l3.978,5.358l1.068-0.803 L10.336,0.52z M4.406,12.76h6.8V11.4h-6.8V12.76z M12.158,7.945L7.03,3.675l0.851-1.02l5.128,4.271L12.158,7.945z M5.357,6.646 l6.053,2.815l0.558-1.21L5.916,5.437L5.357,6.64V6.646z M11.227,10.91L4.494,9.774l0.272-1.306l6.549,1.306L11.227,10.91z" /></svg><span>the-fool</span></a></section></footer>