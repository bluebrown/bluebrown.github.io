<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Nico Braun - Building Production Grade Container Images</title><link rel=icon href=/assets/favicon.ico><link rel=stylesheet href=/assets/base.css><link rel=stylesheet href=/assets/main.css><link rel=stylesheet href=/assets/chroma.css><body class=darker><nav id=nav></nav><section id=page class=post><aside id=menu><div class="tree-root tree-level-0"><section class=tree-level-1><h3>Linux</h3><ul><li class="tree-child tree-level-2"><a href=/linux/kvm-qemu-in-wsl2/>Kvm Qemu In Wsl2</a></ul><ul><li class="tree-child tree-level-2"><a href=/linux/effective-make/>Effective Make</a></ul></section><section class=tree-level-1><h3>Kubernetes</h3><ul><li class="tree-child tree-level-2"><a href=/kubernetes/kubernetes-dns/>Kubernetes Dns</a></ul></section><section class=tree-level-1><h3>Infrastructure</h3><ul><li class="tree-child tree-level-2"><a href=/infrastructure/immutable-cluster/>Immutable Cluster</a></ul></section><section class=tree-level-1><h3>Container</h3><ul><li class="tree-child tree-level-2"><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/docker-sd-and-lb/>Docker Sd And Lb</a></ul></section><section class=tree-level-1><h3>Programming</h3><ul><li class="tree-child tree-level-2"><a href=/programming/bit-flags-in-go/>Bit Flags In Go</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/opengl-windows-vscode/>Opengl Windows Vscode</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/python-cheat-sheet/>Python Cheat Sheet</a></ul></section></div></aside><main id=content><nav><ul class=bread-crumbs><li><a href=/>Home</a><li role=separator class=vr>/<li><a href=/container/>Container</a><li role=separator class=vr>/<li><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images</a></ul></nav><article class=post><section class=post-content><h1 id=building-production-grade-container-images>Building Production Grade Container Images</h1><p>When building and running images locally for development purposes, many best practices are neglected. However, eventually the image gets deployed. For a real deployment we want to take additional steps.<h2 id=motivation>Motivation</h2><p>In this scenario I <em>want</em> to deploy a simple "echo-server" written in go.<p>This is a good example because it is a compiled language, and it spawns a long-running process with which we can interact via HTTP. That is usually the case when deploying application in container.<p>The project structure looks like this<pre tabindex=0 class=chroma><code><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── Dockerfile
</span></span><span class=line><span class=cl>├── .dockerignore
</span></span><span class=line><span class=cl>├── go.mod
</span></span><span class=line><span class=cl>├── main.go
</span></span><span class=line><span class=cl>└── README.md
</span></span></code></pre><details><summary>Go Code</summary><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl> <span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl> <span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=kd>func</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>reqHeadersBytes</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>Marshal</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Header</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>:=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;RemoteAddr: %s\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>RemoteAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>+=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Method: %s\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Method</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>+=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;RequestURI: %s\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>RequestURI</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>+=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Proto: %s\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Proto</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>+=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;ContentLength: %x\n&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>ContentLength</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>text</span> <span class=o>+=</span> <span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Headers: %s\n&#34;</span><span class=p>,</span> <span class=nb>string</span><span class=p>(</span><span class=nx>reqHeadersBytes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprint</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=nx>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=p>})</span>
</span></span><span class=line><span class=cl> <span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:80&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></details><p>You can find the full <a href=https://github.com/bluebrown/echo-server>project</a> on github.<h2 id=dockerignore>Dockerignore</h2><p>With the <code>.dockerignore</code> file we can exclude content from build directory. So what's listed in this file will not get send to the daemon as build part of the context.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ docker build --tag bluebrown/echo-server .
</span></span><span class=line><span class=cl>sending build context to Docker daemon  6.656kB
</span></span><span class=line><span class=cl>...
</span></span></code></pre><p>Its a good idea to list the <code>Dockerfile</code> and the <code>.dockerignore</code> itself here in order to avoid cache invalidation of previous steps when working on these 2 files. Additionally list everything that isn't strictly required for building the image.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>.git
</span></span><span class=line><span class=cl>.dockerignore
</span></span><span class=line><span class=cl>Dockerfile
</span></span><span class=line><span class=cl>README.md
</span></span></code></pre><h2 id=multi-staging>Multi Staging</h2><p>With multi-staging it is possible to perform work in one image and then copy only what is required to a second slim image.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /src/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go vet<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go test<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -ldflags <span class=s1>&#39;-linkmode external -w -extldflags &#34;-static&#34;&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -o echo-server<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># ---</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/usr/code/echo-server&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /src/echo-server /usr/code/<span class=err>
</span></span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker build --tag bluebrown/echo-server .
</span></span><span class=line><span class=cl>docker image ls
</span></span></code></pre><p>If we inspect the output we can see that the final image is much smaller then the builder image. Instead of running eventually a container with the source code and the binary and a size of 868MB, we are going to run only a slim container containing the compiled binary of size 11.7MB<pre tabindex=0 class=chroma><code><span class=line><span class=cl>REPOSITORY              TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>bluebrown/echo-server   latest    ee63052b3b15   <span class=m>9</span> seconds ago    11.7MB
</span></span><span class=line><span class=cl>&lt;none&gt;                  &lt;none&gt;    5eb556bfbc0f   <span class=m>12</span> seconds ago   868MB
</span></span><span class=line><span class=cl>golang                  latest    ee23292e2826   <span class=m>4</span> days ago       862MB
</span></span><span class=line><span class=cl>alpine                  latest    d4ff818577bc   <span class=m>12</span> days ago      5.6MB
</span></span></code></pre><p>It is not always required or useful to use multi-stage build. For example, you can compile the binary outside the image and copy in the final alpine image. However, compiling on build ensures that it is always compiled in the same environment with the same flags.<h2 id=healthcheck>Healthcheck</h2><p>Healthchecks are a way to determine of the container is running ok. By default, the process ID (PID) is checked. So if a container has a PID it is considered healthy.<p>It is possible to customize the healthcheck per image. For example using curl to make a HTTP request to see if the application is responding ok.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>HEALTHCHECK \
</span></span></span><span class=line><span class=cl><span class=err>  --interval=30s \
</span></span></span><span class=line><span class=cl><span class=err>  --timeout=30s \
</span></span></span><span class=line><span class=cl><span class=err>  </span>--start-period<span class=o>=</span>5s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --retries<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  CMD curl --head --fail localhost <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre><p>When running starting the container now, we can also see the health status via CLI.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ docker run --rm  --detach --name echo-server -p 80:80  bluebrown/echo-server
</span></span><span class=line><span class=cl>$ docker ps -a --format <span class=o>{</span>% raw %<span class=o>}</span><span class=s1>&#39;{{.Names}} - {{.Status}}&#39;</span><span class=o>{</span>% endraw %<span class=o>}</span>
</span></span><span class=line><span class=cl>echo-server - Up <span class=m>5</span> seconds <span class=o>(</span>health: starting<span class=o>)</span>
</span></span></code></pre><p>However, if you wait 2 minutes and check again, you notice that the container is marked as unhealthy.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>echo-server - Up <span class=m>2</span> minutes <span class=o>(</span>unhealthy<span class=o>)</span>
</span></span></code></pre><p>You may also notice that even though the container is considered unhealthy, docker doesn't stop it or do anything about it. It is up to the operator or orchestration framework to handle the situation according to the health status. Docker swarm for example would restart the container now.<p>But why was the container <em>unhealthy</em> in the first place? If you try to curl on the published port of the the container you get actually a response.<details><summary>Curl Output</summary><pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ curl localhost
</span></span><span class=line><span class=cl>RemoteAddr: 172.17.0.1:50152
</span></span><span class=line><span class=cl>Method: GET
</span></span><span class=line><span class=cl>RequestURI: /
</span></span><span class=line><span class=cl>Proto: HTTP/1.1
</span></span><span class=line><span class=cl>ContentLength: <span class=m>0</span>
</span></span><span class=line><span class=cl>Headers: <span class=o>{</span><span class=s2>&#34;Accept&#34;</span>:<span class=o>[</span><span class=s2>&#34;*/*&#34;</span><span class=o>]</span>,<span class=s2>&#34;User-Agent&#34;</span>:<span class=o>[</span><span class=s2>&#34;curl/7.68.0&#34;</span><span class=o>]}</span>
</span></span></code></pre></details><p>The reason is, that the health check command is executed inside the container, and in our case we are trying to use curl even though its not installed in the container. We can see this by inspecting the status logs in the docker inspect output.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker inspect echo-server --format <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span> <span class=o>{</span>%raw%<span class=o>}</span>  <span class=err>&#39;</span><span class=o>{{</span>range .State.Health.Log<span class=o>}}{{</span>.End<span class=o>}}</span> <span class=p>|</span> Exit Code: <span class=o>{{</span>.ExitCode<span class=o>}}</span> <span class=p>|</span> <span class=o>{{</span>.Output<span class=o>}}{{</span>end<span class=o>}}</span> <span class=o>{</span>%endraw%<span class=o>}</span>
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>2021-06-30 10:06:05.795671501 +0000 UTC <span class=p>|</span> Exit Code: <span class=m>1</span> <span class=p>|</span> /bin/sh: curl: not found
</span></span><span class=line><span class=cl>2021-06-30 10:06:35.888445198 +0000 UTC <span class=p>|</span> Exit Code: <span class=m>1</span> <span class=p>|</span> /bin/sh: curl: not found
</span></span><span class=line><span class=cl>2021-06-30 10:07:05.959345369 +0000 UTC <span class=p>|</span> Exit Code: <span class=m>1</span> <span class=p>|</span> /bin/sh: curl: not found
</span></span></code></pre><p>We could simply install curl on build in order to fix this.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk add --update curl <span class=o>&amp;&amp;</span> rm -rf /var/cache/apk/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>echo-server - Up <span class=m>33</span> seconds <span class=o>(</span>healthy<span class=o>)</span>
</span></span></code></pre><h2 id=build-arguments>Build Arguments</h2><p>Build arguments are a great way to customize the build behavior without having to modify the <code>Dockerfile</code>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>VET_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go vet <span class=s2>&#34;</span><span class=nv>$VET_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>TEST_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go <span class=nb>test</span> <span class=s2>&#34;</span><span class=nv>$TEST_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>LD_FLAGS</span><span class=o>=</span><span class=s1>&#39;-linkmode external -w -extldflags &#34;-static&#34;&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build -ldflags <span class=s2>&#34;</span><span class=nv>$LD_FLAGS</span><span class=s2>&#34;</span> -o echo-server <span class=s2>&#34;</span><span class=nv>$BUILD_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre><p>That way we can pass additional flags on build. For example being extra verbose for debugging purposes.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker build --tag bluebrown/echo-server <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --build-arg <span class=nv>VET_FLAGS</span><span class=o>=</span><span class=s2>&#34;-x&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --build-arg <span class=nv>BUILD_FLAGS</span><span class=o>=</span><span class=s2>&#34;-x&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  .
</span></span></code></pre><h2 id=using-unprivileged-user>Using Unprivileged User</h2><p>By default, Docker gives root permission to the process that runs a container. That's no good. It's commonly solved by created an unprivileged user inside the container and run the final command as this user.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>UID</span><span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>USER</span><span class=o>=</span><span class=s2>&#34;docker-app&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --disabled-password <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --gecos <span class=s2>&#34;&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --home /usr/code <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --no-create-home <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --uid <span class=s2>&#34;</span><span class=nv>$UID</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> $USER</span><span class=err>
</span></span></span></code></pre><p>Note, when working with local volumes you have to ensure the permission on the volume matches the <code>UID</code> and <code>GUID</code> of that user.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>sudo chown -R 8080:8080 ./my-volume
</span></span><span class=line><span class=cl>docker run --volume <span class=nv>$PWD</span>/my-volume:/usr/data
</span></span></code></pre><h2 id=labeling-the-image>Labeling the Image</h2><p>Label systems are a common way to work with dynamic configuration these days. They are a way to attach key value pairs to resources which can be used by other tools in order to operate given resource.<p>The Open Container Initiative has label suggestions which are commonly known and accepted. <a href=https://github.com/opencontainers/image-spec/blob/master/annotations.md>OCI Annotations</a>. The older deprecated version of the spec has better explanations in my opinion and since many labels were basically just renamed its can be useful too check out <a href=http://label-schema.org/rc1/>label-schema.org documentation</a> as well.<p>The format of the oci labels is <code>org.opencontainers.image.&lt;label></code> where label has to be chosen from a fixed list of labels provided by OCI. If you have custom labels, you should <strong>not</strong> prefix them with <code>org.opencontainers.image</code> but with your own prefix e.g. <code>com.myorg.env="production"</code>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;0.1.0&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>ENVIRONMENT</span><span class=o>=</span><span class=s2>&#34;dev&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BRANCH</span><span class=o>=</span><span class=s2>&#34;main&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>COMMIT_HASH</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>CREATED_DATE</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>LABEL</span> org.opencontainers.image.created<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>CREATED_DATE</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.url<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo&#34;</span>  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.source<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo/Dockerfile&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.version<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nv>ENVIRONMENT</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.revision<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMIT_HASH</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.vendor<span class=o>=</span><span class=s2>&#34;rainbowstack&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.title<span class=o>=</span><span class=s2>&#34;echo-server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.description<span class=o>=</span><span class=s2>&#34;go echo server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.documentation<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo/README.md&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.authors<span class=o>=</span><span class=s2>&#34;nico braun&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.licenses<span class=o>=</span><span class=s2>&#34;(BSD-1-Clause)&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.ref.name<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>BRANCH</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    dev.rainbowstack.environment<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ENVIRONMENT</span><span class=si>}</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>...<span class=err>
</span></span></span></code></pre><p>If you now inspect the image you can find the labels.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker inspect bluebrown/echo-server --format <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span><span class=o>{</span>%raw%<span class=o>}</span>  <span class=s1>&#39;{{range $key, $val := .ContainerConfig.Labels}}{{printf &#34;%s = %s\n&#34; $key $val }}{{end}}&#39;</span><span class=o>{</span>%endraw%<span class=o>}</span>
</span></span></code></pre><details><summary>Output</summary><pre tabindex=0 class=chroma><code><span class=line><span class=cl>dev.rainbowstack.environment <span class=o>=</span> dev
</span></span><span class=line><span class=cl>org.opencontainers.image.authors <span class=o>=</span> nico braun
</span></span><span class=line><span class=cl>org.opencontainers.image.created <span class=o>=</span> unknown
</span></span><span class=line><span class=cl>org.opencontainers.image.description <span class=o>=</span> go <span class=nb>echo</span> server
</span></span><span class=line><span class=cl>org.opencontainers.image.documentation <span class=o>=</span> https://github.com/my-repo/README.md
</span></span><span class=line><span class=cl>org.opencontainers.image.licenses <span class=o>=</span> <span class=o>(</span>BSD-1-Clause<span class=o>)</span>
</span></span><span class=line><span class=cl>org.opencontainers.image.ref.name <span class=o>=</span> main
</span></span><span class=line><span class=cl>org.opencontainers.image.revision <span class=o>=</span> unknown
</span></span><span class=line><span class=cl>org.opencontainers.image.source <span class=o>=</span> https://github.com/my-repo/Dockerfile
</span></span><span class=line><span class=cl>org.opencontainers.image.title <span class=o>=</span> echo-server
</span></span><span class=line><span class=cl>org.opencontainers.image.url <span class=o>=</span> https://github.com/my-repo
</span></span><span class=line><span class=cl>org.opencontainers.image.vendor <span class=o>=</span> rainbowstack
</span></span><span class=line><span class=cl>org.opencontainers.image.version <span class=o>=</span> 0.1.0-dev
</span></span></code></pre></details><h2 id=the-final-dockerfile>The Final Dockerfile</h2><p>The complete Dockerfile looks now like this. We are using <code>.dockerignore</code> and <code>multi-staging</code> to reduce the final image size drastically. An <code>HTTP Healthcheck</code> is implemented to see if the deployed server is actually functioning. <code>Arguments</code> and <code>Labels</code> improve the build customization and allow users and programs to get meta data about the image.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang as builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /src/</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>VET_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go vet <span class=s2>&#34;</span><span class=nv>$VET_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>TEST_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go <span class=nb>test</span> <span class=s2>&#34;</span><span class=nv>$TEST_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>LD_FLAGS</span><span class=o>=</span><span class=s1>&#39;-linkmode external -w -extldflags &#34;-static&#34;&#39;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BUILD_FLAGS</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build -ldflags <span class=s2>&#34;</span><span class=nv>$LD_FLAGS</span><span class=s2>&#34;</span> -o echo-server <span class=s2>&#34;</span><span class=nv>$BUILD_FLAGS</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># ---</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=s> alpine as runner</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;/usr/code/echo-server&#34;</span><span class=p>]</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk add --update curl <span class=o>&amp;&amp;</span> rm -rf /var/cache/apk/*<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>HEALTHCHECK \
</span></span></span><span class=line><span class=cl><span class=err>  --interval=30s \
</span></span></span><span class=line><span class=cl><span class=err>  --timeout=30s \
</span></span></span><span class=line><span class=cl><span class=err>  </span>--start-period<span class=o>=</span>5s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --retries<span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  CMD curl --head --fail localhost <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>UID</span><span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl><span class=k>ARG</span> <span class=nv>USER</span><span class=o>=</span><span class=s2>&#34;docker-app&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> adduser <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --disabled-password <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --gecos <span class=s2>&#34;&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --home /usr/code <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --no-create-home <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    --uid <span class=s2>&#34;</span><span class=nv>$UID</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=s2>&#34;</span><span class=nv>$USER</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>VERSION</span><span class=o>=</span><span class=s2>&#34;0.1.0&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>ENVIRONMENT</span><span class=o>=</span><span class=s2>&#34;dev&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>BRANCH</span><span class=o>=</span><span class=s2>&#34;main&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>COMMIT_HASH</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ARG</span> <span class=nv>CREATED_DATE</span><span class=o>=</span><span class=s2>&#34;unknown&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>LABEL</span> org.opencontainers.image.created<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>CREATED_DATE</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.url<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo&#34;</span>  <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.source<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo/Dockerfile&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.version<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>VERSION</span><span class=si>}</span><span class=s2>-</span><span class=si>${</span><span class=nv>ENVIRONMENT</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.revision<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>COMMIT_HASH</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.vendor<span class=o>=</span><span class=s2>&#34;rainbowstack&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.title<span class=o>=</span><span class=s2>&#34;echo-server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.description<span class=o>=</span><span class=s2>&#34;go echo server&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.documentation<span class=o>=</span><span class=s2>&#34;https://github.com/my-repo/README.md&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.authors<span class=o>=</span><span class=s2>&#34;nico braun&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.licenses<span class=o>=</span><span class=s2>&#34;(BSD-1-Clause)&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    org.opencontainers.image.ref.name<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>BRANCH</span><span class=si>}</span><span class=s2>&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    dev.rainbowstack.environment<span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>ENVIRONMENT</span><span class=si>}</span><span class=s2>&#34;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /src/echo-server /usr/code/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>USER</span><span class=s> $USER</span><span class=err>
</span></span></span></code></pre><h2 id=bonus-content-trust>Bonus: Content Trust</h2><p>If you are using a private registry, consider opting into <a href=https://docs.docker.com/engine/security/trust/>content trust</a>.<p>Since version 1.8 docker supports code signage mechanism for published images. It is not enabled by default but can be enabled via environment flag. When enabled docker will automatically sign published images and verify on pull.<p>Consider running this in your current shell or adding it to your <code>~/.bashrc</code>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nb>export</span> <span class=nv>DOCKER_CONTENT_TRUST</span><span class=o>=</span><span class=m>1</span>
</span></span></code></pre><p>Note, if you are planning to push images you need to take additional steps to <a href=https://docs.docker.com/engine/security/trust/#signing-images-with-docker-content-trust>create your private signage key</a>.</section><footer class=post-footer><p><span>Nico Braun</span>&nbsp;-&nbsp;<time>June 28, 2021</time><p><a href=#nav class=no-pop>Back to Top</a></footer></article></main><aside id=context><section class=toc><h3>What is on this page?</h3><ul><li><a href=#motivation>Motivation</a><li><a href=#dockerignore>Dockerignore</a><li><a href=#multi-staging>Multi Staging</a><li><a href=#healthcheck>Healthcheck</a><li><a href=#build-arguments>Build Arguments</a><li><a href=#using-unprivileged-user>Using Unprivileged User</a><li><a href=#labeling-the-image>Labeling the Image</a><li><a href=#the-final-dockerfile>The Final Dockerfile</a><li><a href=#bonus-content-trust>Bonus: Content Trust</a></ul></section><section class=releated><h3>Related</h3><ul><li><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques
<small>- Nico Braun</small>
<small>- June 27, 2021</small></a><li><a href=/container/docker-sd-and-lb/>Docker Sd And Lb
<small>- Nico Braun</small>
<small>- November 02, 2020</small></a></ul></section></aside></section><footer id=footer><section id=socials><a href=https://github.com/bluebrown class="social-link no-pop"><svg class="social-icon">
<path
  d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8" /></svg><span>bluebrown</span></a>
<a href=https://www.twitter.com/codingsafari class="social-link no-pop"><svg class="social-icon">
<path
  d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" /></svg><span>codingsafari</span></a>
<a href=https://www.linkedin.com/in/nico-braun class="social-link no-pop"><svg class="social-icon">
<path
  d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" /></svg><span>nico-braun</span></a>
<a href=https://stackoverflow.com/users/9208887/the-fool class="social-link no-pop"><svg class="social-icon">
<path
  d="M12.566,14.12v-4.08h1.359v5.44H1.686v-5.44h1.36v4.08H12.566z M10.336,0.52L9.269,1.315l3.978,5.358l1.068-0.803 L10.336,0.52z M4.406,12.76h6.8V11.4h-6.8V12.76z M12.158,7.945L7.03,3.675l0.851-1.02l5.128,4.271L12.158,7.945z M5.357,6.646 l6.053,2.815l0.558-1.21L5.916,5.437L5.357,6.64V6.646z M11.227,10.91L4.494,9.774l0.272-1.306l6.549,1.306L11.227,10.91z" /></svg><span>the-fool</span></a></section></footer>