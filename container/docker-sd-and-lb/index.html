<!doctype html><html lang=en><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Nico Braun - Docker Sd And Lb</title><link rel=icon href=/assets/favicon.ico><link rel=stylesheet href=/assets/base.css><link rel=stylesheet href=/assets/main.css><link rel=stylesheet href=/assets/chroma.css><body class=darker><nav id=nav></nav><section id=page class=post><aside id=menu><div class="tree-root tree-level-0"><section class=tree-level-1><h3>Linux</h3><ul><li class="tree-child tree-level-2"><a href=/linux/kvm-qemu-in-wsl2/>Kvm Qemu In Wsl2</a></ul><ul><li class="tree-child tree-level-2"><a href=/linux/effective-make/>Effective Make</a></ul></section><section class=tree-level-1><h3>Kubernetes</h3><ul><li class="tree-child tree-level-2"><a href=/kubernetes/kubernetes-dns/>Kubernetes Dns</a></ul></section><section class=tree-level-1><h3>Infrastructure</h3><ul><li class="tree-child tree-level-2"><a href=/infrastructure/immutable-cluster/>Immutable Cluster</a></ul></section><section class=tree-level-1><h3>Container</h3><ul><li class="tree-child tree-level-2"><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques</a></ul><ul><li class="tree-child tree-level-2"><a href=/container/docker-sd-and-lb/>Docker Sd And Lb</a></ul></section><section class=tree-level-1><h3>Programming</h3><ul><li class="tree-child tree-level-2"><a href=/programming/bit-flags-in-go/>Bit Flags In Go</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/opengl-windows-vscode/>Opengl Windows Vscode</a></ul><ul><li class="tree-child tree-level-2"><a href=/programming/python-cheat-sheet/>Python Cheat Sheet</a></ul></section></div></aside><main id=content><nav><ul class=bread-crumbs><li><a href=/>Home</a><li role=separator class=vr>/<li><a href=/container/>Container</a><li role=separator class=vr>/<li><a href=/container/docker-sd-and-lb/>Docker Sd And Lb</a></ul></nav><article class=post><section class=post-content><h1 id=docker-service-discovery--loadbalancing-strategies>Docker Service Discovery & Loadbalancing Strategies</h1><p>A common question that arises is how does service discovery in docker work. And how does docker route the traffic.<p>This project showcases some strategies for service discovery with docker and docker-compose. You can find the working examples and this post also in the <a href=https://github.com/bluebrown/docker-sd-and-lb-strategies>github repo</a>.<p>Before we dive into more advanced strategies, lets review some of the basics.<h2 id=dockers-built-in-nameserver--loadbalancer>Dockers built-in Nameserver & Loadbalancer</h2><p>Docker comes with a built-in <a href=https://docs.docker.com/config/containers/container-networking/#dns-services>nameserver</a>. The server is, by default, reachable via <code>127.0.0.11:53</code>.<p>Every container has by default a nameserver entry in <code>/etc/resolve.conf</code>, so it is not required to specify the address of the nameserver from within the container. That is why you can find your service from within the network with <code>service</code> or <code>task_service_n</code>.<p>If you do <code>task_service_n</code> then you will get the address of the corresponding service replica.<p>If you only ask for the <code>service</code> docker will perform <code>internal load balancing</code> between container in the same network and <code>external load balancing</code> to handle requests from outside.<p>When swarm is used, docker will additionally use two special networks.<ol><li>The <code>ingress network</code>, which is actually an <a href=https://docs.docker.com/network/overlay/>overlay network</a> and handles incoming traffic to the swarm. It allows to query any service from any node in the swarm.<li>The <code>docker_gwbridge</code>, a <a href=https://docs.docker.com/network/bridge/>bridge network</a>, which connects the overlay networks of the individual hosts to an their physical network. (including ingress)</ol><p>When using swarm to <a href=https://docs.docker.com/compose/compose-file/#deploy>deploy services</a>, the behavior as described in the examples below will not work unless endpointmode is set to dns roundrobin instead of vip.<blockquote><p>endpoint_mode: vip - Docker assigns the service a virtual IP (VIP) that acts as the front end for clients to reach the service on a network. Docker routes requests between the client and available worker nodes for the service, without client knowledge of how many nodes are participating in the service or their IP addresses or ports. (This is the default.)
endpoint_mode: dnsrr - DNS round-robin (DNSRR) service discovery does not use a single virtual IP. Docker sets up DNS entries for the service such that a DNS query for the service name returns a list of IP addresses, and the client connects directly to one of these. DNS round-robin is useful in cases where you want to use your own load balancer, or for Hybrid Windows and Linux applications.</blockquote><h2 id=example>Example</h2><p>For example deploy three replicas from <em>dig/docker-compose.yml</em><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>whoami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;traefik/whoami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre><h3 id=dns-lookup>DNS Lookup</h3><p>You can use tools such as <a href=https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/deployment_guide/s2-bind-dig>dig</a> or <a href=https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/nslookup>nslookup</a> to do a DNS lookup against the nameserver in the <em>same network</em>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker run --rm --network dig_default tutum/dnsutils dig whoami
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=p>;</span> &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.2-Ubuntu &lt;&lt;&gt;&gt; whoami
</span></span><span class=line><span class=cl><span class=p>;;</span> global options: +cmd
</span></span><span class=line><span class=cl><span class=p>;;</span> Got answer:
</span></span><span class=line><span class=cl><span class=p>;;</span> -&gt;&gt;HEADER<span class=s>&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span class=m>58433</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> flags: qr rd ra<span class=p>;</span> QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> QUESTION SECTION:
</span></span><span class=line><span class=cl><span class=p>;</span>whoami.                                IN      A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> ANSWER SECTION:
</span></span><span class=line><span class=cl>whoami.                 <span class=m>600</span>     IN      A       172.28.0.3
</span></span><span class=line><span class=cl>whoami.                 <span class=m>600</span>     IN      A       172.28.0.2
</span></span><span class=line><span class=cl>whoami.                 <span class=m>600</span>     IN      A       172.28.0.4
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>;;</span> Query time: <span class=m>0</span> msec
</span></span><span class=line><span class=cl><span class=p>;;</span> SERVER: 127.0.0.11#53<span class=o>(</span>127.0.0.11<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> WHEN: Mon Nov <span class=m>16</span> 22:36:37 UTC <span class=m>2020</span>
</span></span><span class=line><span class=cl><span class=p>;;</span> MSG SIZE  rcvd: <span class=m>90</span>
</span></span></code></pre><p>If you are only interested in the IP, you can provide the <code>+short</code> option<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker run --rm --network dig_default tutum/dnsutils dig +short whoami
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>172.28.0.3
</span></span><span class=line><span class=cl>172.28.0.4
</span></span><span class=line><span class=cl>172.28.0.2
</span></span></code></pre><p>Or look for specific service<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker run --rm --network dig_default tutum/dnsutils dig +short dig_whoami_2
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>172.28.0.4
</span></span></code></pre><h3 id=load-balancing>Load balancing</h3><p>The default loadbalancing happens on the transport layer or layer 4 of the <a href=https://www.cloudflare.com/learning/ddos/glossary/open-systems-interconnection-model-osi/>OSI Model</a>. So it is TCP/UDP based. So it is not possible to inspect and manipulate http headers with this method. In the enterprise edition it is apparently possible to use labels similar to the ones traefik is using in the example a bit further down.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker run --rm --network dig_default curlimages/curl -Ls http://whoami
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>Hostname: eedc94d45bf4
</span></span><span class=line><span class=cl>IP: 127.0.0.1
</span></span><span class=line><span class=cl>IP: 172.28.0.3
</span></span><span class=line><span class=cl>RemoteAddr: 172.28.0.5:43910
</span></span><span class=line><span class=cl>GET / HTTP/1.1
</span></span><span class=line><span class=cl>Host: whoami
</span></span><span class=line><span class=cl>User-Agent: curl/7.73.0-DEV
</span></span><span class=line><span class=cl>Accept: */*
</span></span></code></pre><p>Here is the hostname from 10 times curl:<pre tabindex=0 class=chroma><code><span class=line><span class=cl>Hostname: eedc94d45bf4
</span></span><span class=line><span class=cl>Hostname: 42312c03a825
</span></span><span class=line><span class=cl>Hostname: 42312c03a825
</span></span><span class=line><span class=cl>Hostname: 42312c03a825
</span></span><span class=line><span class=cl>Hostname: eedc94d45bf4
</span></span><span class=line><span class=cl>Hostname: d922d86eccc6
</span></span><span class=line><span class=cl>Hostname: d922d86eccc6
</span></span><span class=line><span class=cl>Hostname: eedc94d45bf4
</span></span><span class=line><span class=cl>Hostname: 42312c03a825
</span></span><span class=line><span class=cl>Hostname: d922d86eccc6
</span></span></code></pre><h2 id=health-checks>Health Checks</h2><p><a href=https://docs.docker.com/engine/reference/builder/#healthcheck>Health checks</a>, by default, are done by checking the process id (PID) of the container on the host kernel. If the process is running successfully, the container is considered healthy.<p>Oftentimes other health checks are required. The container may be running but the application inside has crashed. In many cases a TCP or HTTP check is preferred.<p>It is possible to bake a custom health checks into images. For example, using <a href=https://curl.se/docs/manual.html>curl</a> to perform L7 health checks.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> traefik/whoami</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>HEALTHCHECK</span> CMD curl --fail http://localhost <span class=o>||</span> <span class=nb>exit</span> <span class=m>1</span><span class=err>
</span></span></span></code></pre><p>It is also possible to specify the health check via cli when starting the container.<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker run <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --health-cmd <span class=s2>&#34;curl --fail http://localhost || exit 1&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --health-interval<span class=o>=</span>5s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --timeout<span class=o>=</span>3s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  traefik/whoami
</span></span></code></pre><h2 id=example-with-swarm>Example with Swarm</h2><p>As initially mentioned, swarms behavior is different in that it will assign a virtual IP to services by default. Its actually not different its just docker or docker-compose doesn't create real services, it just imitates the behavior of swarm but still runs the container normal setup as services can in fact only be created by manager nodes.<p>Keeping in mind we are on a swarm manager and thus the default mode is VIP<p>Create a overlay network that can be used by regular containers too<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker network create --driver overlay --attachable testnet
</span></span></code></pre><p>create some service with 2 replicas<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker service create --network testnet --replicas <span class=m>2</span> --name digme nginx
</span></span></code></pre><p>Now lets use dig again and making sure we attach the container to the same network<pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ docker run --network testnet --rm tutum/dnsutils dig  digme
</span></span><span class=line><span class=cl>digme.                  <span class=m>600</span>     IN      A       10.0.18.6
</span></span></code></pre><p>We see that indeed we only got one IP address back, so it appears that this is the virtual IP that has been assigned by docker.<p>Swarm allows actually to get the single IPs in this case <strong>without</strong> explicitly setting the endpoint mode.<p>We can query for <code>task.&lt;servicename></code> in this case that is <code>tasks.digme</code><pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ docker run --network testnet --rm tutum/dnsutils dig tasks.digme
</span></span><span class=line><span class=cl>tasks.digme.            <span class=m>600</span>     IN      A       10.0.18.7
</span></span><span class=line><span class=cl>tasks.digme.            <span class=m>600</span>     IN      A       10.0.18.8
</span></span></code></pre><p>This has brought us 2 A records pointing to the individual replicas.<p>Now lets create another service with endpointmode set to dns roundrobin<pre tabindex=0 class=chroma><code><span class=line><span class=cl>docker service create --endpoint-mode dnsrr --network testnet --replicas <span class=m>2</span> --name digme2 nginx
</span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl>$ docker run --network testnet --rm tutum/dnsutils dig digme2
</span></span><span class=line><span class=cl>digme2.                 <span class=m>600</span>     IN      A       10.0.18.21
</span></span><span class=line><span class=cl>digme2.                 <span class=m>600</span>     IN      A       10.0.18.20
</span></span></code></pre><p>This way we get both IPs without adding the prefix <code>tasks</code>.<h2 id=service-discovery--loadbalancing-strategies>Service Discovery & Loadbalancing Strategies</h2><p>If the built in features are not sufficient, some strategies can be implemented to achieve better control. Below are some examples.<h3 id=haproxy>HAProxy</h3><p><a href=https://www.haproxy.com/>Haproxy</a> can use the docker nameserver in combination with <a href=https://www.haproxy.com/blog/whats-new-haproxy-1-8/#server-template-configuration-directive>dynamic server templates</a> to discover the running container. Then the traditional proxy features can be leveraged to achieve powerful layer 7 load balancing with http header manipulation and <a href=https://www.haproxy.com/blog/haproxy-layer-7-retries-and-chaos-engineering/>chaos engineering</a> such as retries.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>loadbalancer</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>haproxy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>443</span><span class=p>:</span><span class=m>443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>whoami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;traefik/whoami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span></code></pre><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=na>...</span>
</span></span><span class=line><span class=cl><span class=na>resolvers docker</span>
</span></span><span class=line><span class=cl>    <span class=na>nameserver dns1 127.0.0.11:53</span>
</span></span><span class=line><span class=cl>    <span class=na>resolve_retries 3</span>
</span></span><span class=line><span class=cl>    <span class=na>timeout resolve 1s</span>
</span></span><span class=line><span class=cl>    <span class=na>timeout retry   1s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold other      10s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold refused    10s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold nx         10s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold timeout    10s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold valid      10s</span>
</span></span><span class=line><span class=cl>    <span class=na>hold obsolete   10s</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span><span class=line><span class=cl><span class=na>backend whoami</span>
</span></span><span class=line><span class=cl>    <span class=na>balance leastconn</span>
</span></span><span class=line><span class=cl>    <span class=na>option httpchk</span>
</span></span><span class=line><span class=cl>    <span class=na>option redispatch 1</span>
</span></span><span class=line><span class=cl>    <span class=na>retry-on all-retryable-errors</span>
</span></span><span class=line><span class=cl>    <span class=na>retries 2</span>
</span></span><span class=line><span class=cl>    <span class=na>http-request disable-l7-retry if METH_POST</span>
</span></span><span class=line><span class=cl>    <span class=na>dynamic-cookie-key MY_SERVICES_HASHED_ADDRESS</span>
</span></span><span class=line><span class=cl>    <span class=na>cookie MY_SERVICES_HASHED_ADDRESS insert dynamic</span>
</span></span><span class=line><span class=cl>    <span class=na>server-template whoami- 6 whoami:80 check resolvers docker init-addr libc,none</span>
</span></span><span class=line><span class=cl><span class=na>...</span>
</span></span></code></pre><h3 id=traefik>Traefik</h3><p>The previous method is already pretty decent. However, you may have noticed that it requires knowing which services should be discovered and also the number of replicas to discover is hard coded. <a href=https://traefik.io/>Traefik</a>, a container native edge router, solves both problems. As long as we enable Traefik via <a href=https://doc.traefik.io/traefik/v1.4/configuration/backends/docker/#labels-overriding-default-behaviour>label</a>, the service will be discovered. This decentralized the configuration. It is as if each service registers itself.<p>The label can also be used to <a href=https://doc.traefik.io/traefik/middlewares/headers/>inspect and manipulate http headers</a>.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;3.8&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>traefik</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;traefik:v2.3&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--log.level=DEBUG&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--api.insecure=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--providers.docker=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--providers.docker.exposedbydefault=false&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;--entrypoints.web.address=:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;80:80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;8080:8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>whoami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;traefik/whoami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.enable=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.port=80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.routers.whoami.entrypoints=web&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.routers.whoami.rule=PathPrefix(`/`)&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.services.whoami.loadbalancer.sticky=true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;traefik.http.services.whoami.loadbalancer.sticky.cookie.name=MY_SERVICE_ADDRESS&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span></code></pre><h3 id=consul>Consul</h3><p><a href=https://www.consul.io/>Consul</a> is a tool for service discovery and configuration management. Services have to be registered via API request. It is a more complex solution that probably only makes sense in bigger clusters, but can be very powerful. Usually it recommended running this on bare metal and not in a container. You could install it alongside the docker host on each server in your cluster.<p>In this example it has been paired with the <a href=https://github.com/gliderlabs/registrator>registrator image</a>, which takes care of registering the docker services in consuls catalog.<p>The catalog can be leveraged in many ways. One of them is to use <a href=https://github.com/hashicorp/consul-template>consul-template</a>.<p>Note that consul comes with its own DNS resolver so in this instance the docker DNS resolver is somewhat neglected.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=s1>&#39;3.8&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>consul</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w>  </span><span class=l>gliderlabs/consul-server:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-advertise=${MYHOST} -server -bootstrap&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>${MYHOST}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=m>8500</span><span class=p>:</span><span class=m>8500</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>registrator</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>gliderlabs/registrator:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-ip ${MYHOST} consul://${MYHOST}:8500&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>registrator</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostname</span><span class=p>:</span><span class=w> </span><span class=l>${MYHOST}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/var/run/docker.sock:/tmp/docker.sock</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>proxy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>build</span><span class=p>:</span><span class=w> </span><span class=l>.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=m>80</span><span class=p>:</span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>depends_on</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=l>consul</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>whoami</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;traefik/whoami&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=s2>&#34;80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span></code></pre><p>Dockerfile for custom proxy image with consul template backed in.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=k>FROM</span><span class=s> nginx</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> curl https://releases.hashicorp.com/consul-template/0.25.1/consul-template_0.25.1_linux_amd64.tgz <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  &gt; consul-template_0.25.1_linux_amd64.tgz<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> gunzip -c consul-template_0.25.1_linux_amd64.tgz <span class=p>|</span> tar xvf -<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> mv consul-template /usr/sbin/consul-template<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> rm /etc/nginx/conf.d/default.conf<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> proxy.conf.ctmpl /etc/nginx/conf.d/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> consul-template.hcl /<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span> <span class=s2>&#34;/bin/bash&#34;</span><span class=p>,</span> <span class=s2>&#34;-c&#34;</span><span class=p>,</span> <span class=s2>&#34;/etc/init.d/nginx start &amp;&amp; consul-template -config=consul-template.hcl&#34;</span> <span class=p>]</span><span class=err>
</span></span></span></code></pre><p>Consul template takes a template file and renders it according to the content of consuls catalog.</p><pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=na>upstream whoami {</span>
</span></span><span class=line><span class=cl><span class=na>{{ range service &#34;whoami&#34; }}</span>
</span></span><span class=line><span class=cl>  <span class=na>server {{ .Address }}:{{ .Port }};</span>
</span></span><span class=line><span class=cl><span class=na>{{ end }}</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=na>server {</span>
</span></span><span class=line><span class=cl>   <span class=na>listen 80;</span>
</span></span><span class=line><span class=cl>   <span class=na>location / {</span>
</span></span><span class=line><span class=cl>      <span class=na>proxy_pass http://whoami;</span>
</span></span><span class=line><span class=cl>   <span class=na>}</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span></code></pre><p>After the template has been changed, the restart command is executed.<pre tabindex=0 class=chroma><code><span class=line><span class=cl><span class=na>consul {</span>
</span></span><span class=line><span class=cl>  <span class=na>address</span> <span class=o>=</span> <span class=s>&#34;consul:8500&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=na>retry {</span>
</span></span><span class=line><span class=cl>    <span class=na>enabled</span>  <span class=o>=</span> <span class=s>true
</span></span></span><span class=line><span class=cl><span class=s>    attempts = 12
</span></span></span><span class=line><span class=cl><span class=s>    backoff  = &#34;250ms&#34;
</span></span></span><span class=line><span class=cl><span class=s>  }</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span><span class=line><span class=cl><span class=na>template {</span>
</span></span><span class=line><span class=cl>  <span class=na>source</span>      <span class=o>=</span> <span class=s>&#34;/etc/nginx/conf.d/proxy.conf.ctmpl&#34;
</span></span></span><span class=line><span class=cl><span class=s>  destination = &#34;/etc/nginx/conf.d/proxy.conf&#34;
</span></span></span><span class=line><span class=cl><span class=s>  perms       = 0600
</span></span></span><span class=line><span class=cl><span class=s>  command = &#34;/etc/init.d/nginx reload&#34;
</span></span></span><span class=line><span class=cl><span class=s>  command_timeout = &#34;60s&#34;</span>
</span></span><span class=line><span class=cl><span class=na>}</span>
</span></span></code></pre><h2 id=feature-table>Feature Table</h2><table><thead><tr><th><th>Built In<th>HAProxy<th>Traefik<th>Consul-Template<tbody><tr><td>Resolver<td>Docker<td>Docker<td>Docker<td>Consul<tr><td>Service Discovery<td>Automatic<td>Server Templates<td>Label System<td>KV Store + Template<tr><td>Health Checks<td>Yes<td>Yes<td>Yes<td>Yes<tr><td>Load Balancing<td>L4<td>L4, L7<td>L4, L7<td>L4, L7<tr><td>Sticky Session<td>No<td>Yes<td>Yes<td>Depends on proxy<tr><td>Metrics<td>No<td>Stats Page<td>Dashboard<td>Dashboard</table></section><footer class=post-footer><p><span>Nico Braun</span>&nbsp;-&nbsp;<time>November 02, 2020</time><p><a href=#nav class=no-pop>Back to Top</a></footer></article></main><aside id=context><section class=toc><h3>What is on this page?</h3><ul><li><a href=#dockers-built-in-nameserver--loadbalancer>Dockers built-in Nameserver & Loadbalancer</a><li><a href=#example>Example</a><ul><li><a href=#dns-lookup>DNS Lookup</a><li><a href=#load-balancing>Load balancing</a></ul><li><a href=#health-checks>Health Checks</a><li><a href=#example-with-swarm>Example with Swarm</a><li><a href=#service-discovery--loadbalancing-strategies>Service Discovery & Loadbalancing Strategies</a><ul><li><a href=#haproxy>HAProxy</a><li><a href=#traefik>Traefik</a><li><a href=#consul>Consul</a></ul><li><a href=#feature-table>Feature Table</a></ul></section><section class=releated><h3>Related</h3><ul><li><a href=/container/building-production-grade-container-images/>Building Production Grade Container Images
<small>- Nico Braun</small>
<small>- June 28, 2021</small></a><li><a href=/container/advanced-entrypoint-techniques/>Advanced Entrypoint Techniques
<small>- Nico Braun</small>
<small>- June 27, 2021</small></a></ul></section></aside></section><footer id=footer><section id=socials><a href=https://github.com/bluebrown class="social-link no-pop"><svg class="social-icon">
<path
  d="M8 0C3.58 0 0 3.582 0 8c0 3.535 2.292 6.533 5.47 7.59.4.075.547-.172.547-.385 0-.19-.007-.693-.01-1.36-2.226.483-2.695-1.073-2.695-1.073-.364-.924-.89-1.17-.89-1.17-.725-.496.056-.486.056-.486.803.056 1.225.824 1.225.824.714 1.223 1.873.87 2.33.665.072-.517.278-.87.507-1.07-1.777-.2-3.644-.888-3.644-3.953 0-.873.31-1.587.823-2.147-.09-.202-.36-1.015.07-2.117 0 0 .67-.215 2.2.82.64-.178 1.32-.266 2-.27.68.004 1.36.092 2 .27 1.52-1.035 2.19-.82 2.19-.82.43 1.102.16 1.915.08 2.117.51.56.82 1.274.82 2.147 0 3.073-1.87 3.75-3.65 3.947.28.24.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.14.46.55.38C13.71 14.53 16 11.53 16 8c0-4.418-3.582-8-8-8" /></svg><span>bluebrown</span></a>
<a href=https://www.twitter.com/codingsafari class="social-link no-pop"><svg class="social-icon">
<path
  d="M16 3.038c-.59.26-1.22.437-1.885.517.677-.407 1.198-1.05 1.443-1.816-.634.37-1.337.64-2.085.79-.598-.64-1.45-1.04-2.396-1.04-1.812 0-3.282 1.47-3.282 3.28 0 .26.03.51.085.75-2.728-.13-5.147-1.44-6.766-3.42C.83 2.58.67 3.14.67 3.75c0 1.14.58 2.143 1.46 2.732-.538-.017-1.045-.165-1.487-.41v.04c0 1.59 1.13 2.918 2.633 3.22-.276.074-.566.114-.865.114-.21 0-.41-.02-.61-.058.42 1.304 1.63 2.253 3.07 2.28-1.12.88-2.54 1.404-4.07 1.404-.26 0-.52-.015-.78-.045 1.46.93 3.18 1.474 5.04 1.474 6.04 0 9.34-5 9.34-9.33 0-.14 0-.28-.01-.42.64-.46 1.2-1.04 1.64-1.7z" /></svg><span>codingsafari</span></a>
<a href=https://www.linkedin.com/in/nico-braun class="social-link no-pop"><svg class="social-icon">
<path
  d="M13.632 13.635h-2.37V9.922c0-.886-.018-2.025-1.234-2.025-1.235 0-1.424.964-1.424 1.96v3.778h-2.37V6H8.51v1.04h.03c.318-.6 1.092-1.233 2.247-1.233 2.4 0 2.845 1.58 2.845 3.637v4.188zM3.558 4.955c-.762 0-1.376-.617-1.376-1.377 0-.758.614-1.375 1.376-1.375.76 0 1.376.617 1.376 1.375 0 .76-.617 1.377-1.376 1.377zm1.188 8.68H2.37V6h2.376v7.635zM14.816 0H1.18C.528 0 0 .516 0 1.153v13.694C0 15.484.528 16 1.18 16h13.635c.652 0 1.185-.516 1.185-1.153V1.153C16 .516 15.467 0 14.815 0z" /></svg><span>nico-braun</span></a>
<a href=https://stackoverflow.com/users/9208887/the-fool class="social-link no-pop"><svg class="social-icon">
<path
  d="M12.566,14.12v-4.08h1.359v5.44H1.686v-5.44h1.36v4.08H12.566z M10.336,0.52L9.269,1.315l3.978,5.358l1.068-0.803 L10.336,0.52z M4.406,12.76h6.8V11.4h-6.8V12.76z M12.158,7.945L7.03,3.675l0.851-1.02l5.128,4.271L12.158,7.945z M5.357,6.646 l6.053,2.815l0.558-1.21L5.916,5.437L5.357,6.64V6.646z M11.227,10.91L4.494,9.774l0.272-1.306l6.549,1.306L11.227,10.91z" /></svg><span>the-fool</span></a></section></footer>